<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Provider CPT Claims Report</title>
  <style>
    :root { --blue:#2563eb; --slate:#1e3a8a; --bg:#f9fafb; --line:#e5e7eb; --text:#111827; --green:#059669; --green-bg:#d1fae5; --red:#b91c1c; --red-bg:#fee2e2; }
    body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
    h1, h2, h3 { color: var(--slate); }
    textarea, input, button, select { font-family: inherit; }
    textarea { width: 100%; height: 150px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-bottom: 12px; background:white; }
    input, select { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; background:white; }
    button { background: var(--blue); color: white; border: none; padding: 9px 14px; border-radius: 8px; cursor: pointer; margin-right: 6px; }
    button.secondary { background: white; color: var(--blue); border: 1px solid var(--blue); }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .card { background: white; border-radius: 12px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 16px; border:1px solid #eef2f7; }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid var(--line); padding: 8px 10px; text-align: left; font-size: 13px; background:white; }
    th { background-color: #f3f4f6; font-weight: 600; }
    tr:nth-child(even) td { background-color: #fbfdff; }
    .note { color:#374151; font-size:13px; }
    .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; letter-spacing: .2px; }
    .pill-paid { background: var(--green-bg); color: var(--green); border: 1px solid #a7f3d0; }
    .pill-unpaid { background: var(--red-bg); color: var(--red); border: 1px solid #fecaca; }
    .section-title { display:flex; align-items:center; justify-content:space-between; }
    .muted { color:#6b7280; font-size:12px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
    .provider-list { display:flex; flex-wrap:wrap; gap:8px; max-height:120px; overflow:auto; padding:6px; border:1px dashed var(--line); border-radius:8px; background:#fff; }
    .provider-list label { display:flex; align-items:center; gap:6px; padding:4px 8px; border:1px solid var(--line); border-radius:999px; background:#f8fafc; font-size:12px; }
    @media print { button, textarea, input, select, .note { display:none; } .card { box-shadow:none; border:1px solid var(--line); break-inside: avoid; } }
  </style>
</head>
<body>
  <h1>Provider CPT Claims Report</h1>
  <p class="note">Upload or paste CSV/TSV. The report auto-extracts the provider (if present) and shows an A/Q/L summary with claim-level detail. Supports comparing up to 5 providers and multi-file upload.</p>
  <div class="row" style="margin-bottom:8px;">
    <label>Provider Name: <input type="text" id="providerName" placeholder="Used if Provider column missing" /></label>
    <input type="file" accept=".csv,.tsv" multiple onchange="readFiles(this)">
  </div>
  <textarea id="data" placeholder="Paste data here..."></textarea>
  <div>
    <button onclick="analyze()">Generate Report</button>
    <button class="secondary" onclick="document.getElementById('data').value='';document.getElementById('output').innerHTML='';document.getElementById('providerName').value='';">Clear</button>
  </div>

  <div id="output"></div>

  <script>
    // ---------- File load ----------
    function readFile(input){
      const file = input.files && input.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e => document.getElementById('data').value = e.target.result;
      reader.readAsText(file);
    }
    async function readFiles(input){
      const files = Array.from(input.files || []);
      if (!files.length) return;
      if (files.length > 5){ alert('Please select at most 5 files. Using the first 5.'); files.length = 5; }
      const texts = await Promise.all(files.map(f=>f.text()));
      // Use header from first non-empty file; strip duplicate headers from subsequent files
      let header = '';
      const bodyLines = [];
      for (let t of texts){
        const norm = t.replace(/\r\n?|\n/g, '\n');
        const lines = norm.split('\n').filter(l=>l.trim().length>0);
        if (!lines.length) continue;
        if (!header){ header = lines[0]; bodyLines.push(...lines.slice(1)); }
        else {
          const maybeHeader = lines[0].trim();
          const startIdx = (maybeHeader.toLowerCase() === header.trim().toLowerCase()) ? 1 : 0;
          bodyLines.push(...lines.slice(startIdx));
        }
      }
      if (!header){ alert('No readable rows found in the selected files.'); return; }
      document.getElementById('data').value = [header, ...bodyLines].join('\n');
    }

    // ---------- Parsing ----------
    function detectDelimiter(text){
      const first = (text.split(/\r?\n/).find(l => l.trim().length) || '');
      return first.includes('\t') ? '\t' : ',';
    }

    function parseDelimited(text, delim){
      const rows = [];
      let field = '', row = [], inQuotes = false;
      for (let i = 0; i < text.length; i++){
        const c = text[i];
        if (inQuotes){
          if (c === '"'){
            const next = text[i+1];
            if (next === '"'){ field += '"'; i++; }
            else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === delim) { row.push(field); field = ''; }
          else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
          else if (c !== '\r') { field += c; }
        }
      }
      if (field.length || row.length){ row.push(field); rows.push(row); }
      return rows.map(r => r.map(x => (x ?? '').trim())).filter(r => r.some(x => x !== ''));
    }

    // ---------- Helpers ----------
    function normalizeMoney(str){
      if (!str) return 0;
      let s = String(str).replace(/[$,\s]/g, '').trim();
      if (s.startsWith('(') && s.endsWith(')')) s = '-' + s.slice(1, -1);
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function idxOf(header, candidates){
      const lower = header.map(h => (h||'').toLowerCase());
      for (const cand of candidates){
        const i = lower.indexOf(cand.toLowerCase());
        if (i !== -1) return i;
      }
      return -1;
    }

    function mostCommon(arr){
      const c = new Map();
      for (const v of arr){ if(!v) continue; c.set(v, (c.get(v)||0)+1); }
      let best = '', bestN = 0; for (const [k,n] of c){ if(n>bestN){best=k;bestN=n;} }
      return best || '';
    }

    function parseDOS(str){
      if(!str) return null;
      const s = String(str).trim();
      const iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(iso) return new Date(+iso[1], +iso[2]-1, +iso[3]);
      const mdy = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
      if(mdy){ let y = +mdy[3]; if(y<100) y+=2000; return new Date(y, +mdy[1]-1, +mdy[2]); }
      const t = Date.parse(s);
      return isNaN(t)? null : new Date(t);
    }

    // ---------- Main ----------
    function analyze(){
      const text = document.getElementById('data').value.trim();
      const output = document.getElementById('output');
      output.innerHTML = '';
      if (!text){ alert('Please paste data or upload a file.'); return; }

      const delim = detectDelimiter(text);
      const rows = parseDelimited(text, delim);
      if (rows.length < 2){ output.innerHTML = '<p>No rows detected.</p>'; return; }

      const header = rows[0];
      const dataRows = rows.slice(1);
      const iCPT = idxOf(header, ['cpt']);
      const iUnits = idxOf(header, ['days_or_units','units','days']);
      const iCharges = idxOf(header, ['charges','charge']);
      const iPaid = idxOf(header, ['insurance_payment','paid','payment']);
      const iPatient = idxOf(header, ['patient_name','patient']);
      const iPatientID = idxOf(header, ['patient_id','id']);
      const iDOS = idxOf(header, ['date_of_service','dos','date']);
      const iProvider = idxOf(header, [
        'provider','rendering provider','rendering_provider','attending','attending_provider',
        'billing provider','billing_provider','ordering provider','ordering_provider','physician','provider_name','office provider'
      ]);

      if (iCPT === -1){ output.innerHTML = '<p>Could not find a CPT column.</p>'; return; }

      // Extract A/Q/L claims only
      const claims = [];
      const providerVals = [];
      for (const r of dataRows){
        const cpt = String(r[iCPT] || '').trim();
        if (!/^[AQL]/i.test(cpt)) continue;
        const units = parseFloat(r[iUnits]) || 0;
        const charge = normalizeMoney(r[iCharges]);
        const paid = Math.abs(normalizeMoney(r[iPaid]));
        const patient = r[iPatient] || '';
        const patient_id = r[iPatientID] || '';
        const providerCellRaw = (iProvider!==-1 ? (r[iProvider]||'') : '').trim();
        const provider = providerCellRaw || (document.getElementById('providerName').value.trim() || 'Unknown Provider');
        if (provider) providerVals.push(provider);
        const isPaid = paid > 0;
        const dos = iDOS!==-1 ? (r[iDOS]||'') : '';
        const d = parseDOS(dos);
        const dateSort = d? d.getTime() : Infinity;
        const codeType = /^[AQL]/i.test(cpt) ? cpt[0].toUpperCase() : '';
        const claimNo = claims.length + 1;
        claims.push({ claimNo, provider, cpt, codeType, units, charge, paid, patient, patient_id, isPaid, dos, dateSort });
      }

      if (!claims.length){ output.innerHTML = '<p>No A/Q/L codes found.</p>'; return; }

      // Provider set & default selection (top 5 by units)
      const providers = Array.from(new Set(claims.map(c=>c.provider))).sort((a,b)=>a.localeCompare(b));
      const byProvUnits = new Map();
      claims.forEach(c=> byProvUnits.set(c.provider, (byProvUnits.get(c.provider)||0)+c.units));
      const top5 = providers.slice().sort((a,b)=> (byProvUnits.get(b)||0) - (byProvUnits.get(a)||0)).slice(0,5);
      const selectedProviders = new Set(top5);

      // ===== Report header =====
      const reportHeader = document.createElement('div');
      reportHeader.className = 'card';
      const pLabel = providers.length>1 ? `${providers.length} providers` : providers[0] || (document.getElementById('providerName').value.trim()||'Unknown Provider');
      reportHeader.innerHTML = `<div class="section-title"><h2>Report for ${pLabel}</h2><span class="muted">Generated: ${new Date().toLocaleString()}</span></div>
      <div class="muted">A/Q/L codes only</div>`;
      output.appendChild(reportHeader);

      // ===== Provider Comparison =====
      const provCard = document.createElement('div');
      provCard.className = 'card';
      provCard.innerHTML = `<div class="section-title"><h3>Provider Comparison (A/Q/L)</h3><span class="muted">Select up to 5 providers</span></div>`;

      const provControls = document.createElement('div');
      provControls.className = 'provider-list';
      providers.forEach(p=>{
        const lbl = document.createElement('label');
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=p; cb.checked = selectedProviders.has(p);
        cb.addEventListener('change', ()=>{
          const checked = Array.from(provControls.querySelectorAll('input[type=checkbox]:checked'));
          if (checked.length>5){ cb.checked=false; alert('Please select at most 5 providers.'); return; }
          selectedProviders.clear(); checked.forEach(x=> selectedProviders.add(x.value));
          renderProviderComparison();
          rebuildAndRenderSummary();
          renderClaims();
        });
        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(p));
        provControls.appendChild(lbl);
      });
      provCard.appendChild(provControls);

      const provTable = document.createElement('table');
      provTable.innerHTML = `<thead><tr>
        <th>Provider</th>
        <th>Total Units</th>
        <th>Units Paid</th>
        <th>Units Unpaid</th>
        <th>Paid %</th>
        <th>L Units</th>
        <th>Q Units</th>
        <th>A Units</th>
      </tr></thead>`;
      const provBody = document.createElement('tbody');
      provTable.appendChild(provBody);
      provCard.appendChild(provTable);
      output.appendChild(provCard);

      function renderProviderComparison(){
        provBody.innerHTML='';
        const provs = selectedProviders.size? Array.from(selectedProviders) : providers;
        provs.sort((a,b)=> (byProvUnits.get(b)||0) - (byProvUnits.get(a)||0));
        provs.forEach(p=>{
          const rows = claims.filter(c=>c.provider===p);
          const totalUnits = rows.reduce((s,x)=>s+x.units,0);
          const unitsPaid = rows.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
          const unitsUnpaid = totalUnits - unitsPaid;
          const paidPct = totalUnits? Math.round((unitsPaid/totalUnits)*100) : 0;
          const L = rows.filter(r=>r.codeType==='L').reduce((s,x)=>s+x.units,0);
          const Q = rows.filter(r=>r.codeType==='Q').reduce((s,x)=>s+x.units,0);
          const A = rows.filter(r=>r.codeType==='A').reduce((s,x)=>s+x.units,0);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${p}</td><td>${Math.round(totalUnits)}</td><td>${Math.round(unitsPaid)}</td><td>${Math.round(unitsUnpaid)}</td><td>${paidPct}%</td><td>${Math.round(L)}</td><td>${Math.round(Q)}</td><td>${Math.round(A)}</td>`;
          provBody.appendChild(tr);
        });
      }
      renderProviderComparison();

      // ===== High‑Level Summary by CPT Code =====
      const summaryCard = document.createElement('div');
      summaryCard.className = 'card';
      summaryCard.innerHTML = `<h3>High‑Level Summary by CPT Code (A/Q/L)</h3>`;

      const controls = document.createElement('div');
      controls.className = 'controls';
      const codeSelect = document.createElement('select');
      codeSelect.id = 'codeFilter';

      const paidSelect = document.createElement('select');
      paidSelect.id = 'paidFilter';
      paidSelect.innerHTML = `
        <option value="">All payment states</option>
        <option value="paid">Paid only</option>
        <option value="unpaid">Unpaid only</option>`;
      controls.appendChild(document.createTextNode('Filter:'));
      controls.appendChild(codeSelect);
      controls.appendChild(paidSelect);
      summaryCard.appendChild(controls);

      const summaryTable = document.createElement('table');
      summaryTable.innerHTML = '<thead><tr>'+
        '<th style="width:14%">CPT Code</th>'+
        '<th style="width:14%">Total Units</th>'+
        '<th style="width:14%">Units Paid</th>'+
        '<th style="width:14%">Units Unpaid</th>'+
        '<th style="width:14%">Paid %</th>'+
        '<th style="width:14%">Encounters</th>'+
        '<th style="width:16%">Total Paid ($)</th>'+
        '</tr></thead>';
      const sbody = document.createElement('tbody');
      const sfoot = document.createElement('tfoot');

      function rebuildAndRenderSummary(){
        const filteredClaims = claims.filter(c=> selectedProviders.size? selectedProviders.has(c.provider) : true);
        const byCode = new Map();
        filteredClaims.forEach(r=>{ if(!byCode.has(r.cpt)) byCode.set(r.cpt, []); byCode.get(r.cpt).push(r); });
        const codes = Array.from(byCode.keys()).sort((a,b)=>a.localeCompare(b));
        codeSelect.innerHTML = `<option value="">All CPT codes (${codes.length})</option>` + codes.map(c=>`<option value="${c}">${c}</option>`).join('');
        const codeRows = codes.map(code=>{
          const vals = byCode.get(code);
          const totalUnits = vals.reduce((s,x)=>s+x.units,0);
          const unitsPaid = vals.filter(x=>x.isPaid).reduce((s,x)=>s+x.units,0);
          const unitsUnpaid = totalUnits - unitsPaid;
          const encounters = new Set(vals.map(x=> x.patient_id || x.patient)).size;
          const totalPaid = vals.reduce((s,x)=>s+x.paid,0);
          return { code, totalUnits, unitsPaid, unitsUnpaid, encounters, totalPaid };
        });
        sbody.innerHTML='';
        const selCode = codeSelect.value;
        const selPaid = paidSelect.value;
        let T_total=0, T_paid=0, T_amt=0;
        codeRows.forEach(r=>{
          if (selCode && r.code !== selCode) return;
          if (selPaid==='paid' && r.unitsPaid===0) return;
          if (selPaid==='unpaid' && r.unitsUnpaid===0) return;
          const paidPct = r.totalUnits ? Math.round((r.unitsPaid/r.totalUnits)*100) : 0;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.code}</td>
            <td>${Math.round(r.totalUnits)}</td>
            <td>${Math.round(r.unitsPaid)}</td>
            <td>${Math.round(r.unitsUnpaid)}</td>
            <td>${paidPct}%</td>
            <td>${r.encounters}</td>
            <td>$${r.totalPaid.toFixed(2)}</td>`;
          sbody.appendChild(tr);
          T_total += r.totalUnits; T_paid += r.unitsPaid; T_amt += r.totalPaid;
        });
        const T_unpaid = T_total - T_paid; const T_pct = T_total ? Math.round((T_paid/T_total)*100) : 0;
        sfoot.innerHTML = `<tr><td><strong>Total</strong></td><td><strong>${Math.round(T_total)}</strong></td><td><strong>${Math.round(T_paid)}</strong></td><td><strong>${Math.round(T_unpaid)}</strong></td><td><strong>${T_pct}%</strong></td><td></td><td><strong>$${T_amt.toFixed(2)}</strong></td></tr>`;
        // Save state (if you later re-enable exports)
        window.reportState = { provider: (providers.length>1? 'Multiple Providers' : providers[0]||'Unknown Provider'), claims: filteredClaims, codeRows };
      }
      rebuildAndRenderSummary();
      codeSelect.addEventListener('change', rebuildAndRenderSummary);
      paidSelect.addEventListener('change', rebuildAndRenderSummary);

      summaryTable.appendChild(sbody);
      summaryTable.appendChild(sfoot);
      summaryCard.appendChild(summaryTable);
      output.appendChild(summaryCard);

      // ===== All Individual Claims =====
      const detailsCard = document.createElement('div');
      detailsCard.className = 'card';
      detailsCard.innerHTML = `<div class="section-title"><h3>All Individual Claims (A/Q/L)</h3>
        <div class="controls">
          <label>Provider: <select id="claimProvFilter"><option value="">All</option></select></label>
          <label>CPT: <select id="claimCodeFilter"><option value="">All</option></select></label>
          <label>Status: <select id="claimStatusFilter">
            <option value="">All</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select></label>
          <label>DOS from: <input type="date" id="claimFrom"></label>
          <label>to: <input type="date" id="claimTo"></label>
        </div>
      </div>`;

      const tbl = document.createElement('table');
      tbl.innerHTML = '<thead><tr><th style="width:6%">#</th><th style="width:16%">Provider</th><th style="width:20%">Patient</th><th style="width:10%">Patient ID</th><th style="width:10%">CPT</th><th style="width:8%">Units</th><th style="width:12%">DOS</th><th style="width:12%">Charge ($)</th><th style="width:12%">Paid ($)</th><th style="width:8%">Status</th></tr></thead>';
      const tb = document.createElement('tbody');

      const claimProvFilter = detailsCard.querySelector('#claimProvFilter');
      const claimCodeFilter = detailsCard.querySelector('#claimCodeFilter');
      const claimStatusFilter = detailsCard.querySelector('#claimStatusFilter');
      const claimFrom = detailsCard.querySelector('#claimFrom');
      const claimTo = detailsCard.querySelector('#claimTo');

      const provOpts = providers.map(p=>`<option value="${p}">${p}</option>`).join('');
      claimProvFilter.innerHTML = '<option value="">All</option>' + provOpts;
      const codeSet = Array.from(new Set(claims.map(c=>c.cpt))).sort((a,b)=>a.localeCompare(b));
      claimCodeFilter.innerHTML = '<option value="">All</option>' + codeSet.map(c=>`<option value="${c}">${c}</option>`).join('');

      function renderClaims(){
        tb.innerHTML='';
        const selProv = claimProvFilter.value;
        const selCode = claimCodeFilter.value;
        const selStatus = claimStatusFilter.value; // '', 'paid', 'unpaid'
        const fromVal = claimFrom.value ? new Date(claimFrom.value).getTime() : -Infinity;
        const toVal = claimTo.value ? new Date(claimTo.value).getTime() : Infinity;
        const base = claims.filter(c=> selectedProviders.size? selectedProviders.has(c.provider): true);
        base.forEach(r=>{
          if (selProv && r.provider !== selProv) return;
          if (selCode && r.cpt !== selCode) return;
          if (selStatus==='paid' && !r.isPaid) return;
          if (selStatus==='unpaid' && r.isPaid) return;
          const t = r.dateSort;
          if (!(t>=fromVal && t<=toVal)) return;
          const pill = r.isPaid ? '<span class="pill pill-paid">PAID</span>' : '<span class="pill pill-unpaid">UNPAID</span>';
          tb.innerHTML += `<tr>
              <td>${r.claimNo}</td>
              <td>${r.provider}</td>
              <td>${r.patient}</td>
              <td>${r.patient_id}</td>
              <td>${r.cpt}</td>
              <td>${Math.round(r.units)}</td>
              <td>${r.dos||''}</td>
              <td>$${r.charge.toFixed(2)}</td>
              <td>$${r.paid.toFixed(2)}</td>
              <td>${pill}</td>
            </tr>`;
        });
      }
      renderClaims();
      claimProvFilter.addEventListener('change', renderClaims);
      claimCodeFilter.addEventListener('change', renderClaims);
      claimStatusFilter.addEventListener('change', renderClaims);
      claimFrom.addEventListener('change', renderClaims);
      claimTo.addEventListener('change', renderClaims);

      tbl.appendChild(tb);
      detailsCard.appendChild(tbl);
      output.appendChild(detailsCard);

      // Save state (placeholder for potential exports)
      window.reportState = { provider: (providers.length>1? 'Multiple Providers' : providers[0]||'Unknown Provider'), claims, codeRows: [] };
    }
  </script>
</body>
</html>
